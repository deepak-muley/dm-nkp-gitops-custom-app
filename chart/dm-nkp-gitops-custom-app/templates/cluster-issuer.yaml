{{- if and .Values.tls.enabled .Values.tls.clusterIssuer.create }}
# ClusterIssuer for Let's Encrypt (cert-manager)
# This is a cluster-wide resource - only create once per cluster
# Let's Encrypt provides FREE TLS certificates for any domain
#
# ⚠️ PREREQUISITES:
#   1. cert-manager must be installed: kubectl get pods -n cert-manager
#   2. Domain must resolve to your LoadBalancer IP (for HTTP-01 challenge)
#   3. Port 80 must be accessible from internet (for HTTP-01 challenge)
#
# Rate Limits (Let's Encrypt Production):
#   - 50 certificates per registered domain per week
#   - 5 duplicate certificates per week
#   - Use staging server for testing to avoid rate limits
#
# Troubleshooting:
#   kubectl describe clusterissuer {{ .Values.tls.clusterIssuer.name }}
#   kubectl logs -n cert-manager -l app.kubernetes.io/name=cert-manager
---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: {{ .Values.tls.clusterIssuer.name }}
  labels:
    {{- include "dm-nkp-gitops-custom-app.labels" . | nindent 4 }}
spec:
  acme:
    # ACME server URL
    # Production: https://acme-v02.api.letsencrypt.org/directory
    # Staging: https://acme-staging-v02.api.letsencrypt.org/directory
    server: {{ .Values.tls.clusterIssuer.server | quote }}
    
    # Email for Let's Encrypt notifications
    email: {{ .Values.tls.clusterIssuer.email | quote }}
    
    # Secret to store ACME account private key
    privateKeySecretRef:
      name: {{ .Values.tls.clusterIssuer.privateKeySecretRef }}
    
    # ACME challenge solvers
    solvers:
      # HTTP-01 Challenge using Gateway API
      # cert-manager creates temporary HTTPRoute for challenge
      - http01:
          gatewayHTTPRoute:
            parentRefs:
              - name: {{ .Values.tls.clusterIssuer.solvers.http01.gatewayHTTPRoute.parentRefs.name | default .Values.gateway.parentRef.name }}
                namespace: {{ .Values.tls.clusterIssuer.solvers.http01.gatewayHTTPRoute.parentRefs.namespace | default .Values.gateway.parentRef.namespace }}
                kind: Gateway
{{- end }}
